trigger:
- master

jobs:
  - job: 'Test'
    pool:
      vmImage: 'Ubuntu-16.04'
    strategy:
      matrix:
        Python37:
          python.version: '3.7'
      maxParallel: 2
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '$(python.version)'
          architecture: 'x64'
      - script: python -m pip install --upgrade tox codecov
        displayName: install tox

      - script: tox -e py27,py34,py35,py36,py37 --junitxml=report.xml
        displayName: run tox for Python runtimes
      
      - script: tox -e typing
        displayName: run tox for typing
   
      - script: tox -e lint,docs
        displayName: run tox for documentation and code linting
      
      - script: tox -e pypi-description,changelog
        displayName: run tox for metadata

      - script: |
          coverage combine
          codecov -t $(CODECOV_TOKEN)
        displayName: Report Coverage

      - task: PublishTestResults@2
        inputs:
          testResultsFiles: 'report.xml'
          testRunTitle: '$(Agent.OS) - $(Build.DefinitionName) - Python $(python.version)'
        condition: succeededOrFailed()

  - job: Build_Packages
    dependsOn: 'Test'
    pool:
      vmImage: 'Ubuntu-16.04'

    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.x'
          architecture: 'x64'

      - script: |
          python -m pip install --upgrade wheel
          python setup.py sdist bdist_wheel
        displayName: 'Build sdist & wheel'
